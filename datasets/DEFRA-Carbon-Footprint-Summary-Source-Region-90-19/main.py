#!/usr/bin/env python
# coding: utf-8
#     DEFRA-Carbon-Footprint-Summary-Source-Region-90-19

import pandas as pd
from gssutils import *

metadata = Scraper(seed='info.json')

distribution = metadata.distribution(
    mediaType="application/vnd.oasis.opendocument.spreadsheet",
    title=lambda x: "UK full dataset 1990 - 2019, including conversion factors by SIC code"
    in x,
)

tabs = {tab.name: tab for tab in distribution.as_databaker()}

# +
tidied_sheets = []
for name, tab in tabs.items():
    
    if 'Summary_source_region_90-19' not in name:
        continue

# Greenhouse gas emissions
    unwanted_cell = tab.excel_ref("A34").expand(DOWN).expand(RIGHT).is_not_blank()
    period = tab.excel_ref("B4").expand(DOWN).is_not_blank().is_not_whitespace() - unwanted_cell
    country = tab.excel_ref("C2").expand(RIGHT).is_not_blank().is_not_whitespace()
    observations = tab.excel_ref("C4").expand(DOWN).fill(RIGHT).is_not_blank() - unwanted_cell
    measure = 'Greenhouse gas emissions'
    unit = 'kt CO2e'
    
    dimensions = [
        HDim(period,'Period',DIRECTLY,LEFT),
        HDim(country,'Country',DIRECTLY, ABOVE),
        HDimConst("Measure", measure),
        HDimConst("Unit", unit)
    ]
    tidy_sheet = ConversionSegment(tab, dimensions, observations) 
    tidied_sheets.append(tidy_sheet.topandas())

# from Carbon Dioxide Emission
    period = tab.excel_ref("B38").expand(DOWN).is_not_blank().is_not_whitespace()
    country = tab.excel_ref("C36").expand(RIGHT).is_not_blank().is_not_whitespace()
    observations = tab.excel_ref("C38").expand(DOWN).fill(RIGHT).is_not_blank()
    measure = 'Carbon dioxide emissions'
    unit = 'kt CO2'

    dimensions = [
        HDim(period,'Period',DIRECTLY,LEFT),
        HDim(country,'Country',DIRECTLY,ABOVE),
        HDimConst("Measure", measure),
        HDimConst("Unit", unit)
    ]
    tidy_sheet = ConversionSegment(tab, dimensions, observations) 
    tidied_sheets.append(tidy_sheet.topandas())
    # savepreviewhtml(tidy_sheet,fname=tab.name + "Preview.html")
# -


df = pd.concat(tidied_sheets, sort=True)

df.rename(columns={'OBS' : 'Value'}, inplace=True)
df['Period'] = df['Period'].astype(float).astype(int)
df['Period'] = df['Period'].map(lambda x: 'year/' + str(x))
df['Value'] = df['Value'].astype(float).round(3)
df = df.drop_duplicates()

indexNames = df[df['Country'] == 'Total'].index
df.drop(indexNames, inplace=True)

df['Measure'] = df['Measure'].apply(pathify)
df['Unit'] = df['Unit'].apply(pathify)
df = df[['Period', 'Country', 'Measure', 'Unit', 'Value']]

metadata.dataset.title = "Carbon Footprint - Summary Source Region 90-19"
metadata.dataset.comment = "Annual greenhouse gas and carbon dioxide emissions relating to UK and other countries consumption." 
metadata.dataset.description = """
This publication looks at the carbon footprint for the UK and other countries.

The carbon footprint refers to emissions that are associated with the 
consumption spending of Uk/other countries residents on goods and services, 
wherever in the world these emissions arise along the supply chain, and those 
which are directly generated by households through private motoring and burning fuel to heat homes. 
These emissions are often referred to as 'consumption emissions' to distinguish them from estimates relating to 
the emissions 'produced' within a country's territory or economic sphere.

The next release see statistics release calendar

Defra statistics: environment

Email enviro.statistics@defra.gov.uk
"""

df.to_csv('observations.csv', index=False)
catalog_metadata = metadata.as_csvqb_catalog_metadata()
catalog_metadata.to_json_file('catalog-metadata.json')